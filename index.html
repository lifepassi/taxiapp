<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>íƒì‹œ ê¸°ì‚¬ ì•±</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  padding: 14px;
  font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", sans-serif;
  background: #f2f4f6;
  font-size: 19px;
}
h1 {
  text-align: center;
  font-size: 28px;
  margin-bottom: 16px;
}
.card {
  background: #fff;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 16px;
}
input, button {
  width: 100%;
  padding: 14px;
  margin-top: 10px;
  font-size: 19px;
  border-radius: 12px;
  border: 1px solid #ccc;
}
button {
  background: #007aff;
  color: #fff;
  border: none;
  font-weight: bold;
}
.row {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
  font-size: 21px;
}
.list div {
  padding: 10px 0;
  border-bottom: 1px solid #eee;
}
canvas {
  max-width: 100%;
}
</style>
</head>

<body>

<h1>ğŸš• íƒì‹œ ê¸°ì‚¬ ì•±</h1>

<div class="card">
  <input id="empId" placeholder="ì‚¬ë²ˆ ì…ë ¥">
  <button onclick="loadData()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
</div>

<div class="card">
  <h3>ğŸ“Š ëˆ„ì  í•©ê³„</h3>
  <div class="row"><span>ìˆ˜ìµ</span><strong id="sumIncome">0</strong></div>
  <div class="row"><span>ê±°ë¦¬</span><strong id="sumDistance">0</strong></div>
  <div class="row"><span>LPG</span><strong id="sumLpg">0</strong></div>
  <div class="row"><span>í•˜ë£¨ í‰ê·  ìˆ˜ìµ</span><strong id="avgIncome">0</strong></div>
</div>

<div class="card">
  <h3>â• ì˜¤ëŠ˜ ê¸°ë¡</h3>
  <input type="number" id="income" placeholder="ìˆ˜ìµ">
  <input type="number" id="distance" placeholder="ê±°ë¦¬">
  <input type="number" id="lpg" placeholder="LPG">
  <button onclick="saveData()">ì €ì¥</button>
</div>

<div class="card">
  <h3>ğŸ“… ë‚ ì§œë³„ ê¸°ë¡</h3>
  <input type="date" id="datePick">
  <div class="list" id="dailyList"></div>
</div>

<div class="card">
  <h3>ğŸ“† ì›”ë³„ í•©ê³„</h3>
  <input type="month" id="monthPick">
  <div class="row"><span>ìˆ˜ìµ</span><strong id="monthIncome">0</strong></div>
  <div class="row"><span>ê±°ë¦¬</span><strong id="monthDistance">0</strong></div>
  <div class="row"><span>LPG</span><strong id="monthLpg">0</strong></div>
</div>

<div class="card">
  <h3>ğŸ“ˆ ì›”ë³„ ìˆ˜ìµ ê·¸ë˜í”„</h3>
  <canvas id="chart"></canvas>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbysFKS12TwPrCnkuSgIouihAwpl7R0b05P5i_H0zEkzssuCl2DGYWl_cTgZFpcz_mTT/exec";
let empId = localStorage.getItem("empId") || "";
let allData = [];
let chart;

document.getElementById("empId").value = empId;

function loadData() {
  empId = document.getElementById("empId").value.trim();
  if (!empId) return alert("ì‚¬ë²ˆ ì…ë ¥í•˜ì„¸ìš”");
  localStorage.setItem("empId", empId);

  fetch(`${API_URL}?empId=${empId}`)
    .then(r => r.json())
    .then(d => {
      allData = d;
      calcTotal();
      drawChart();
      alert("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
    });
}

function calcTotal() {
  let i=0,d=0,l=0;
  const days = new Set();

  allData.forEach(r=>{
    i+=Number(r.income);
    d+=Number(r.distance);
    l+=Number(r.lpg);
    days.add(r.date);
  });

  sumIncome.innerText = i;
  sumDistance.innerText = d;
  sumLpg.innerText = l;
  avgIncome.innerText = days.size ? Math.round(i/days.size) : 0;
}

function saveData() {
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      empId,
      income: income.value,
      distance: distance.value,
      lpg: lpg.value
    })
  }).then(()=>{
    income.value = distance.value = lpg.value = "";
    loadData();
  });
}

datePick.onchange = e => {
  dailyList.innerHTML = "";
  allData.filter(r=>r.date===e.target.value).forEach(r=>{
    dailyList.innerHTML += `<div>
      ìˆ˜ìµ ${r.income} / ê±°ë¦¬ ${r.distance} / LPG ${r.lpg}
    </div>`;
  });
};

monthPick.onchange = e => {
  let i=0,d=0,l=0;
  allData.filter(r=>r.date.startsWith(e.target.value)).forEach(r=>{
    i+=+r.income; d+=+r.distance; l+=+r.lpg;
  });
  monthIncome.innerText = i;
  monthDistance.innerText = d;
  monthLpg.innerText = l;
};

function drawChart() {
  const map = {};
  allData.forEach(r=>{
    const m = r.date.slice(0,7);
    map[m] = (map[m]||0) + Number(r.income);
  });

  const labels = Object.keys(map).sort();
  const data = labels.map(l=>map[l]);

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type: "bar",
    data: {
      labels,
      datasets: [{ label: "ì›” ìˆ˜ìµ", data }]
    }
  });
}
</script>

</body>
</html>
